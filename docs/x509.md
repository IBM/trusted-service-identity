# Tornjak + SPIRE with x509pop (Proof of Possession) for Confidential Computing project
The `x509pop` nodeAttestor plugin attests nodes that have been provisioned with
an x509 identity through an out-of-band mechanism.
It verifies that the certificate is rooted to a trusted set of CAs
and issues a signature based proof-of-possession challenge to the agent plugin
to verify that the node is in possession of the private key.


## Pre-install: Get the code and create Keys
### Get the code
Obtain the clone of the repo:

```console
git clone https://github.com/IBM/trusted-service-identity.git
git checkout conf_container
```
### Create keys and certificates for testing
Keys are already created in `sample-x509` directory.

To create new keys:

To test the configuration and setup, one can use the already rendered
Keys and Certs:
https://github.com/spiffe/spire/blob/v1.2.0/test/fixture/nodeattestor/x509pop/

To tool for generating them:
https://github.com/spiffe/spire/blob/v1.2.0/test/fixture/nodeattestor/x509pop/generate.go

Sample execution:
```console
cd sample-x509
go run generate.go
cd ..
```

Setting up the keys for SPIRE Server:
* generate rootCA key
* create rootCert (rootKey)
* generate intermediate Key
* create intermediateCert(intermKey, rootKey, rootCert)


## Install the SPIRE Server with OIDC and Vault
Server NodeAttestor just needs the rootCA cert for verification (rootCA.pem)

Pass the cert as a Secret:
```console

kubectl -n tornjak create secret generic sample-x509 \
--from-file=rootCA.pem="sample-x509/root-crt.pem"
```

### Server deployment
Here we are using OpenShift cluster in IBM Cloud.
Setup `KUBECONFIG` and deploy:

```console
# use a script to get CLUSTER_NAME
utils/get-cluster-info.sh

# or set it up explicitly:
export CLUSTER_NAME=openshift-ibmcloud-01
utils/install-open-shift-tornjak.sh -c $CLUSTER_NAME -t openshift.space-x.com --oidc
```

Test Access the Tornjak
http://tornjak-http-tornjak.openshift-ibmcloud-01-9d995c4a8c7c5f281ce13d5467ff6a94-0000.us-south.containers.appdomain.cloud/

Test Access to OIDC:
```console
curl -k https://oidc-tornjak.openshift-ibmcloud-01-9d995c4a8c7c5f281ce13d5467ff6a94-0000.us-south.containers.appdomain.cloud/.well-known/openid-configuration
```

Capture the `spire-bundle` to be used for Spire Agents:

```console
kubectl -n tornjak get configmap spire-bundle -oyaml | kubectl patch --type json --patch '[{"op": "replace", "path": "/metadata/namespace", "value":"spire"}]' -f - --dry-run=client -oyaml > spire-bundle.yaml
```

### Setup Vault with OIDC:
https://github.com/IBM/trusted-service-identity/blob/main/docs/spire-oidc-vault.md

## Deploy SPIRE Agents in Remote Clusters
Follow the pre-Install steps above to get the code and the keys. Keys are already created in `sample-x509` directory.


## Deploy the keys
Eventually, the x509 cert will be delivered to the host out-of-bound, but for now, let's pass them as secrets.

```console
# create a namespace:
kubectl create ns spire

# create a secret with keys:
kubectl -n spire create secret generic agent-x509 \
--from-file=key.pem="sample-x509/leaf1-key.pem" \
--from-file=cert.pem="sample-x509/leaf1-crt-bundle.pem"
```

### Setup env.
Deploy `spire-bundle` obtained from the SPIRE server.

```console
kubectl -n spire create -f spire-bundle.yaml
```

Get the cluster name and region.
In IBM cloud, use the script:

```console
utils/get-cluster-info.sh
# otherwise setup directly:
export CLUSTER_NAME=
export REGION=us-south
```

Point at the SPIRE Server:
```console
export SPIRE_SERVER=spire-server-tornjak.openshift-ibmcloud-01-9d995c4a8c7c5f281ce13d5467ff6a94-0000.us-south.containers.appdomain.cloud
```


Install the Spire Agents

If installing on OpenShift:

```console
utils/install-open-shift-spire.sh -c $CLUSTER_NAME -r $REGION -s $SPIRE_SERVER -t openshift.space-x.com
```

If installing in native Kubernetes environment:

```console
helm install --set "spireServer.address=$SPIRE_SERVER" \
--set "namespace=spire" \
--set "clustername=$CLUSTER_NAME" --set "trustdomain=openshift.space-x.com" \
--set "region=$REGION" \
--set "x509=true" --set \
--set "openShift=false" spire charts/spire --debug
```


### To cleanup the cluster (removes everything)

```console
utils/install-open-shift-spire.sh --clean
```
